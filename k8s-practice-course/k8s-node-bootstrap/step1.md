## Join Node01 with TLS Bootstrap


### Based on following documentation
- https://kubernetes.io/docs/reference/access-authn-authz/bootstrap-tokens/
- https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/


### Steps:

<details><summary>1. Create Bootstrap Token Secret: `07401b.f395accd246ae52d`</summary><p>

```
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Secret
metadata:
  # Name MUST be of form "bootstrap-token-<token id>"
  name: bootstrap-token-07401b
  namespace: kube-system

# Type MUST be 'bootstrap.kubernetes.io/token'
type: bootstrap.kubernetes.io/token
stringData:
  # Human readable description. Optional.
  description: "The default bootstrap token generated by 'kubeadm init'."

  # Token ID and secret. Required.
  token-id: 07401b
  token-secret: f395accd246ae52d

  # Expiration. Optional.
  expiration: 2020-10-10T03:22:11Z

  # Allowed usages.
  usage-bootstrap-authentication: "true"
  usage-bootstrap-signing: "true"

  # Extra groups to authenticate the token as. Must start with "system:bootstrappers:"
  auth-extra-groups: system:bootstrappers:worker,system:bootstrappers:ingress
EOF
```{{execute master}}
</p></details>

<details><summary>2. Create Signing ConfigMap in `kube-public` namespace</summary><p>

```
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: ConfigMap
metadata:
  name: cluster-info
  namespace: kube-public
data:
  jws-kubeconfig-07401b: eyJhbGciOiJIUzI1NiIsImtpZCI6IjA3NDAxYiJ9..tYEfbo6zDNo40MQE07aZcQX2m3EB2rO3NuXtxVMYm9U
  kubeconfig: |
    apiVersion: v1
    clusters:
    - cluster:
        certificate-authority-data: $(kubectl config view --raw -o jsonpath='{.clusters[0].cluster.certificate-authority-data}')
        server: $(kubectl config view -o jsonpath='{.clusters[0].cluster.server}')
      name: ""
    contexts: []
    current-context: ""
    kind: Config
    preferences: {}
    users: []
EOF
```{{execute master}}
</p></details>


<details><summary>3. Enable bootstrapping nodes to create CSR</summary><p>

```
cat <<EOF | kubectl apply -f -
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: create-csrs-for-bootstrapping
subjects:
- kind: Group
  name: system:bootstrappers
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: system:node-bootstrapper
  apiGroup: rbac.authorization.k8s.io
EOF
```{{execute master}}
</p></details>

<details><summary>4. Approve all CSRs for the group "system:bootstrappers"</summary><p>

```
cat <<EOF | kubectl apply -f -
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: auto-approve-csrs-for-group
subjects:
- kind: Group
  name: system:bootstrappers
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: system:certificates.k8s.io:certificatesigningrequests:nodeclient
  apiGroup: rbac.authorization.k8s.io
EOF
```{{execute master}}
</p></details>

<details><summary>5. Approve renewal CSRs for the group "system:nodes"</summary><p>

```
cat <<EOF | kubectl apply -f -
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: auto-approve-renewals-for-nodes
subjects:
- kind: Group
  name: system:nodes
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: system:certificates.k8s.io:certificatesigningrequests:selfnodeclient
  apiGroup: rbac.authorization.k8s.io
EOF
```{{execute master}}
</p></details>

<details><summary>6. Generate `bootstrap-kubelet.conf`</summary><p>

```
kubectl config --kubeconfig=/tmp/bootstrap-kubelet.conf \
  set-cluster bootstrap \
  --server=$(kubectl config view -o jsonpath='{.clusters[0].cluster.server}') \
  --certificate-authority=/etc/kubernetes/pki/ca.crt \
  --embed-certs=true

kubectl config --kubeconfig=/tmp/bootstrap-kubelet.conf \
  set-credentials kubelet-bootstrap \
  --token=07401b.f395accd246ae52d

kubectl config --kubeconfig=/tmp/bootstrap-kubelet.conf \
  set-context bootstrap \
  --user=kubelet-bootstrap \
  --cluster=bootstrap

kubectl config --kubeconfig=/tmp/bootstrap-kubelet.conf \
  use-context bootstrap
```{{execute master}}

And Copy it to node01:
```
scp -o StrictHostKeyChecking=no /tmp/bootstrap-kubelet.conf node01:/etc/kubernetes/bootstrap-kubelet.conf
```{{execute master}}
</p></details>



<details><summary>7. Go to node01 and start kubelet</summary><p>

```
ssh -o StrictHostKeyChecking=no node01 "systemctl start kubelet"
```{{execute master}}
</p></details>


<details><summary>8. Check that `node01` has joined the cluster</summary><p>

```
kubectl get nodes
```{{execute master}}
</p></details>

