## Join Node01 with TLS Bootstrap


### Based on following documentation
- https://kubernetes.io/docs/reference/access-authn-authz/bootstrap-tokens/
- https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/


### Steps:

<details><summary>1. Create Bootstrap Token</summary><p>

**Requirements:**
<ul style="list-style-type:circle;">
  <li>Token ID: 07401b</li>
  <li>Token Secret: f395accd246ae52d</li>
  <li>auth-extra-groups: system:bootstrappers:node01</li>
  <li>Namespace: kube-system</li>
</ul>

<details><summary>Solution:</summary><p>

```
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Secret
metadata:
  # Name MUST be of form "bootstrap-token-<token id>"
  name: bootstrap-token-07401b
  namespace: kube-system

# Type MUST be 'bootstrap.kubernetes.io/token'
type: bootstrap.kubernetes.io/token
stringData:
  # Human readable description. Optional.
  description: "The default bootstrap token generated by 'kubeadm init'."

  # Token ID and secret. Required.
  token-id: 07401b
  token-secret: f395accd246ae52d

  # Allowed usages.
  usage-bootstrap-authentication: "true"
  usage-bootstrap-signing: "true"

  # Extra groups to authenticate the token as. Must start with "system:bootstrappers:"
  auth-extra-groups: system:bootstrappers:node01
EOF
```{{execute master}}
</p></details>
</p></details>

<details><summary>2. Create Signing ConfigMap</summary><p>

**Requirements:**
<ul style="list-style-type:circle;">
  <li>Namespace: kube-public</li>
  <li>Name: cluster-info</li>
</ul>


<details><summary>Solution:</summary><p>
```
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: ConfigMap
metadata:
  name: cluster-info
  namespace: kube-public
data:
  kubeconfig: |
    apiVersion: v1
    clusters:
    - cluster:
        certificate-authority-data: $(kubectl config view --raw -o jsonpath='{.clusters[0].cluster.certificate-authority-data}')
        server: $(kubectl config view -o jsonpath='{.clusters[0].cluster.server}')
      name: ""
    contexts: []
    current-context: ""
    kind: Config
    preferences: {}
    users: []
EOF
```{{execute master}}
</p></details>
</p></details>


<details><summary>3. Authorize kubelet to create CSR</summary><p>

**Requirements:**
<ul style="list-style-type:circle;">
  <li>ClusterRoleBinding Name: create-csrs-for-bootstrapping</li>
  <li>ClusterRole: system:node-bootstrapper</li>
  <li>Group: system:bootstrappers</li>
</ul>

<details><summary>Solution:</summary><p>
```
kubectl create \
  clusterrolebinding create-csrs-for-bootstrapping \
  --clusterrole=system:node-bootstrapper \
  --group=system:bootstrappers
```{{execute master}}
</br>
</br>
It will create following configuration:
```
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: create-csrs-for-bootstrapping
subjects:
- kind: Group
  name: system:bootstrappers
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: system:node-bootstrapper
  apiGroup: rbac.authorization.k8s.io
```
</p></details>
</p></details>


<details><summary>4. Create Kubelet Bootstrap Configuration</summary><p>

**Requirements:**
<ul style="list-style-type:circle;">
  <li>Host: node01</li>
  <li>Filename: /etc/kubernetes/bootstrap-kubelet.conf</li>
  <li>Bootstrap file: /etc/kubernetes/bootstrap-kubelet.conf</li>
</ul>

<details><summary>Solution:</summary><p>

On `master` node:
```
kubectl config --kubeconfig=/tmp/bootstrap-kubelet.conf \
  set-cluster bootstrap \
  --server=$(kubectl config view -o jsonpath='{.clusters[0].cluster.server}') \
  --certificate-authority=/etc/kubernetes/pki/ca.crt \
  --embed-certs=true

kubectl config --kubeconfig=/tmp/bootstrap-kubelet.conf \
  set-credentials kubelet-bootstrap \
  --token=07401b.f395accd246ae52d

kubectl config --kubeconfig=/tmp/bootstrap-kubelet.conf \
  set-context bootstrap \
  --user=kubelet-bootstrap \
  --cluster=bootstrap

kubectl config --kubeconfig=/tmp/bootstrap-kubelet.conf \
  use-context bootstrap
```{{execute master}}

</br>
</br>
Then, copy it to `node01`:
```
scp -o StrictHostKeyChecking=no /tmp/bootstrap-kubelet.conf node01:/etc/kubernetes/bootstrap-kubelet.conf
```{{execute master}}
</p></details>
</p></details>


<details><summary>5. Configure Kubelet to run in bootstrap mode</summary><p>

**Requirements:**
<ul style="list-style-type:circle;">
  <li>Host: node01</li>
  <li>Service file: /lib/systemd/system/kubelet.service</li>
  <li>Bootstrap file: /etc/kubernetes/bootstrap-kubelet.conf</li>
  <li>CGroup Driver: systemd</li>
</ul>


<details><summary>Solution:</summary><p>

```
sed -i 's@ExecStart=.*@ExecStart=/usr/bin/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --cgroup-driver=systemd@' /lib/systemd/system/kubelet.service
systemctl daemon-reload
systemctl start kubelet
```{{execute NODE01}}
</p></details>
</p></details>


<details><summary>6. Check that node01 sent CSR for approval</summary><p>

**Requirements:**
<ul style="list-style-type:circle;">
  <li>Host: master</li>
</ul>


<details><summary>Solution:</summary><p>

```
kubectl get csr
```{{execute master}}
</p></details>
</p></details>

<details><summary>7. Approve CSRs automatically</summary><p>

**Requirements:**
<ul style="list-style-type:circle;">
  <li>ClusterRoleBinding Name: auto-approve-csrs-for-group</li>
  <li>ClusterRole: system:certificates.k8s.io:certificatesigningrequests:nodeclient</li>
  <li>Group: system:bootstrappers</li>
</ul>


<details><summary>Solution:</summary><p>

```
kubectl create \
  clusterrolebinding auto-approve-csrs-for-group \
  --clusterrole=system:certificates.k8s.io:certificatesigningrequests:nodeclient \
  --group=system:bootstrappers
```{{execute master}}

</br>
</br>
It will create following configuration:
```
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: auto-approve-csrs-for-group
subjects:
- kind: Group
  name: system:bootstrappers
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: system:certificates.k8s.io:certificatesigningrequests:nodeclient
  apiGroup: rbac.authorization.k8s.io
```
</p></details>
</p></details>


<details><summary>8. Approve Renewal CSRs</summary><p>

**Requirements:**
<ul style="list-style-type:circle;">
  <li>ClusterRoleBinding Name: auto-approve-renewals-for-nodes</li>
  <li>ClusterRole: system:certificates.k8s.io:certificatesigningrequests:selfnodeclient</li>
  <li>Group: system:nodes</li>
</ul>


<details><summary>Solution:</summary><p>

```
kubectl create \
  clusterrolebinding auto-approve-renewals-for-nodes \
  --clusterrole=system:certificates.k8s.io:certificatesigningrequests:selfnodeclient \
  --group=system:nodes
```{{execute master}}

</br>
</br>
It will create following configuration:
```
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: auto-approve-renewals-for-nodes
subjects:
- kind: Group
  name: system:nodes
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: system:certificates.k8s.io:certificatesigningrequests:selfnodeclient
  apiGroup: rbac.authorization.k8s.io
```
</p></details>
</p></details>


<details><summary>9. Restart Kubelet on Node01 and Check CSR Status</summary><p>


<details><summary>Solution:</summary><p>

```
systemctl stop kubelet
systemctl start kubelet
```{{execute HOST2}}

```
kubectl get csr
```{{execute}}
</p></details>
</p></details>

<details><summary>10. Check cluster nodes</summary><p>


<details><summary>Solution:</summary><p>

```
kubectl get nodes
```{{execute}}
</p></details>
</p></details>

